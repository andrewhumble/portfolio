test_string = """
e|-------------------------------------------------------------------------|
B|--0---1---3---12----12---12----12---0---1---3---12---12----12---12-------|
G|----0---0---0---0-0---0----0-0--------0---0---0---0----0-0----0----0-0---|
D|-------------------------------------------------------------------------|
A|------0---2---10----10---10----10-------0---2---10---10----10---10-------|
E|--3---------------------------------3------------------------------------|
 
e|------3-------5------------------3---------------------------------------|
B|--5-------7-------8----8-----7-------5----4----3----2----1-----0---------|
G|----0---0---0------0-0---0-0-----------0-0--0-0--0-0--0-0--0-0-----------|
D|---------------------------------------------------------0---------------|
A|--3---4---5---6---7----6-----5---4---3----3----2----0--------------------|
E|---------------------------------------------------------------3---------|
 
e|-------------------------------------------------------------------------|
B|--5-----3---2----1----0------0----1---3---12----12---12----12------------|
G|---0-----0---0-0--0-0----------0----0---0----0-0---0----0-0--------------|
D|-----------------0-------------------------------------------------------|
A|--3-----2---0---------------------0---2---10----10---10----10------------|
E|----------------------3------3-------------------------------------------|
 
e|------3-------5------------------3---------------------------------------|
B|--5-------7-------8----8-----7---------5----4----3----2----1------0------|
G|--------------------0-0--0-0------------0-0--0-0--0-0--0-0--0-0----------|
D|-----------------------------------------------------------0-------------|
A|--3---4---5---6---7----6-----5---4-----3----3----2----0------------------|
E|------------------------------------------------------------------3------|
 
e|-------------------------------------------------------------------------|
B|--10—-8---6---5---3----5--------10---8---6---5---3---2----1----0---------|
G|----0---0---0---0---0-0------------0---0---0---0---0--0-0--0-0-----------|
D|----------------------------------------------------------0--------------|
A|---8--7---5---3---1----3---------8---7---5---3---1---0-------------------|
E|---------------------------------------------------------------3---------|
 
e|-------------------------------------------|
B|--0---1---3---12----12---12----12----------|
G|----0---0---0---0-0---0----0-0-------------|
D|-------------------------------------------|
A|------0---2---10----10---10----10----------|
E|--3----------------------------------------|
 
e|------3-------5------------------3---------------------------------------|
B|--5-------7-------8----8-----7-------5----4----3----2----1--------0------|
G|--------------------0-0--0-0-----------0-0--0-0--0-0--0-0--0-0-----------|
D|---------------------------------------------------------0---------------|
A|--3---4---5---6---7----6-----5---4---3----3----2----0--------------------|
E|------------------------------------------------------------------3------|
 
e|-------------------------------------------------------------------------|
B|--10—-8---6---5---3----5--------10---8---6---5---3---2----1----0---------|
G|----0---0---0---0---0-0------------0---0---0---0---0--0-0--0-0-----------|
D|----------------------------------------------------------0--------------|
A|---8--7---5---3---1----3---------8---7---5---3---1---0-------------------|
E|---------------------------------------------------------------3---------|
 
e|-------------------------------------------------------------------------|
B|--0---1---3---12----12---12----12----------------------------------------|
G|----0---0---0---0-0---0----0-0-------------------------------------------|
D|-------------------------------------------------------------------------|
A|------0---2---10----10---10----10----------------------------------------|
E|--3----------------------------------------------------------------------|
"""

import json
import re
from music21 import pitch

# Standard tuning for a 6-string guitar
# STANDARD_TUNING = [pitch.Pitch(n) for n in ['E4', 'B3', 'G3', 'D3', 'A2', 'E2']]
# BASE_NOTES = ["e", "B", "G", "D", "A", "E"]
STANDARD_TUNING = [pitch.Pitch(n) for n in ['E2', 'A2', 'D3', 'G3', 'B3', 'E4']]
BASE_NOTES = ["E", "A", "D", "G", "B", "e"]

def get_note_name(string_num: int, fret: int) -> str:
    if not (1 <= string_num <= 6 and 0 <= fret <= 24):
        raise ValueError("Invalid string or fret number.")
    return STANDARD_TUNING[string_num - 1].transpose(fret).nameWithOctave

# Split tab into sections separated by empty lines
sections = [s for s in re.split(r'\n\s*\n', test_string.strip()) if s.strip()]

notes_output = []
sequence = 0

for section in sections:
    lines = [line for line in section.splitlines() if re.match(r'^[eBGDAE]\|', line)]
    tab_lines = {line.split("|", 1)[0].strip(): line.split("|", 1)[1] for line in lines}
    length = len(tab_lines['e'])
    
    for i in range(length):
        group = []
        for s in BASE_NOTES:
            if s in tab_lines:
                char = tab_lines[s][i]
                if char.isdigit() and (i == 0 or not tab_lines[s][i - 1].isdigit()):
                    fret = char
                    if i + 1 < length and tab_lines[s][i + 1].isdigit():
                        fret += tab_lines[s][i + 1]
                    string_num = BASE_NOTES.index(s) + 1
                    group.append({
                        "string": string_num,
                        "fret": int(fret),
                        "note": get_note_name(string_num, int(fret))
                    })
        if group:
            notes_output.append({
                "string": [n["string"] for n in group],
                "fret": [n["fret"] for n in group],
                "note": [n["note"] for n in group],
                "sequence": sequence
            })
            sequence += 1

with open('public/song_output.json', 'w') as json_file:
    json.dump(notes_output, json_file, indent=4)
